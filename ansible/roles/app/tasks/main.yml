# App Role - Deploy GreenCity application stack
---
- name: Copy docker-compose file
  ansible.builtin.copy:
    src: docker-compose.lb.yml
    dest: "{{ app_dir }}/docker-compose.yml"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: "0644"

- name: Copy nginx configuration
  ansible.builtin.copy:
    src: nginx-lb.conf
    dest: "{{ app_dir }}/nginx/nginx-lb.conf"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: "0644"

- name: Create environment file
  ansible.builtin.template:
    src: env.prod.j2
    dest: "{{ app_dir }}/.env.prod"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: "0600"

- name: Pull container images
  community.docker.docker_image:
    name: "{{ item }}"
    source: pull
    force_source: true
  loop:
    - "{{ images.frontend }}"
    - "{{ images.backcore }}"
    - "{{ images.backuser }}"
    - "{{ images.postgres }}"

- name: Start application stack
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    files:
      - docker-compose.yml
    env_files:
      - .env.prod
    state: present
    pull: never
  register: compose_output

- name: Display container status
  ansible.builtin.debug:
    msg: "Containers started: {{ compose_output.containers | default([]) | length }}"
